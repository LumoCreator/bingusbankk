<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BingusBank Ultra</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root {
            --primary: #FF6B00;
            --primary-grad: linear-gradient(135deg, #FF6B00, #FF4500);
            --bg: #F0F2F5;
            --white: #FFFFFF;
            --text: #111111;
            --gray: #8E8E93;
            --light-gray: #F7F8FA;
            --success: #34C759;
            --danger: #FF3B30;
            --nav-height: 90px;
            --shadow: 0 8px 24px rgba(0,0,0,0.06);
        }

        * { 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
        }

        html, body { 
            background-color: var(--bg);
            margin: 0; padding: 0; 
            width: 100%; height: 100%; 
            overflow: hidden;
            color: var(--text);
            user-select: none;
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { 
            from { transform: translateY(100%); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }

        /* --- Components --- */
        #loading-screen { 
            position: fixed; inset: 0; background: var(--white); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 9999;
        }
        .loader-ring {
            width: 40px; height: 40px;
            border: 3px solid #eee; border-top: 3px solid var(--primary);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        .btn-loader {
            width: 18px; height: 18px;
            border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .app-container { 
            width: 100%; height: 100%; max-width: 500px; margin: 0 auto; 
            position: relative; background: var(--bg); overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
        }

        .screen { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            padding: 24px; 
            display: none; flex-direction: column; 
            background: var(--bg); 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 130px; 
        }
        
        .screen.active { display: flex; animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .screen::-webkit-scrollbar { display: none; }

        /* --- Headers & Text --- */
        h1 { font-size: 32px; font-weight: 800; margin: 0 0 10px 0; }
        h2 { font-size: 22px; font-weight: 700; margin: 0; }
        p { color: var(--gray); margin: 0; font-size: 15px; line-height: 1.4; }

        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 0 20px 0; flex-shrink: 0;
        }

        .user-avatar {
            width: 48px; height: 48px; 
            background: #fff; border-radius: 50%; 
            display:flex; align-items:center; justify-content:center; 
            box-shadow: var(--shadow);
            overflow: hidden; cursor: pointer;
            border: 2px solid white;
            transition: transform 0.2s;
        }
        .user-avatar:active { transform: scale(0.9); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* --- Cards --- */
        .cards-wrapper {
            display: flex; overflow-x: auto; scroll-snap-type: x mandatory;
            gap: 16px; scrollbar-width: none; 
            padding: 10px 4px 30px 4px;
            margin: 0 -4px; flex-shrink: 0;
        }
        .cards-wrapper::-webkit-scrollbar { display: none; }

        .bank-card {
            min-width: 290px; width: 88%; 
            scroll-snap-align: center; aspect-ratio: 1.58 / 1;
            border-radius: 26px; padding: 24px;
            color: white; display: flex; flex-direction: column; justify-content: space-between; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.15), 0 5px 15px rgba(0,0,0,0.1);
            position: relative; cursor: pointer; overflow: hidden;
            transition: transform 0.2s cubic-bezier(0.3, 0, 0, 1);
        }
        .bank-card:active { transform: scale(0.97); }

        /* --- UI Blocks --- */
        .glass-panel {
            background: var(--white);
            border-radius: 24px; padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        /* --- Forms --- */
        input {
            width: 100%; padding: 18px; margin-bottom: 14px; 
            border-radius: 18px; border: none;
            background: var(--white); font-size: 16px; outline: none;
            box-shadow: var(--shadow); color: var(--text);
            transition: 0.2s;
        }
        input:focus {
            box-shadow: 0 0 0 2px var(--primary);
        }

        .btn { 
            width: 100%; padding: 18px; background: var(--text); 
            color: white; border: none; border-radius: 20px; 
            font-size: 16px; font-weight: 600; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: all 0.2s; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.96); }
        .btn.primary { background: var(--primary-grad); box-shadow: 0 10px 30px rgba(255, 107, 0, 0.3); }
        .btn.secondary { background: var(--white); color: var(--text); }
        .btn.danger { background: #FF3B30; color: white; box-shadow: 0 5px 15px rgba(255, 59, 48, 0.3); }

        /* --- Bottom Nav (Corrected) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: none; 
            /* Grid layout for precise centering */
            display: grid;
            grid-template-columns: 1fr 1fr 70px 1fr 1fr; 
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 20px; z-index: 1000;
            max-width: 500px; margin: 0 auto;
        }
        
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #C1C1C5; font-size: 10px; font-weight: 600; gap: 5px;
            height: 100%; cursor: pointer; transition: 0.2s;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 26px; height: 26px; fill: currentColor; }
        .nav-item:active { transform: scale(0.9); }

        /* Center SBP Button */
        .nav-center-wrapper {
            position: relative; display: flex; justify-content: center;
        }
        .nav-center-btn {
            width: 64px; height: 64px;
            background: var(--primary-grad);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: white;
            box-shadow: 0 10px 25px rgba(255, 107, 0, 0.4);
            position: absolute; bottom: 10px; /* Float up */
            border: 5px solid var(--bg); /* fake transparent border */
            transition: transform 0.2s;
        }
        .nav-center-btn:active { transform: scale(0.9); }
        .nav-center-btn svg { width: 30px; height: 30px; fill: white; }

        /* --- Transactions List --- */
        .tx-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid rgba(0,0,0,0.03);
            animation: slideUp 0.4s ease forwards; opacity: 0;
        }
        .tx-icon {
            width: 44px; height: 44px; border-radius: 16px; 
            background: var(--light-gray); display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-right: 15px;
        }

        /* --- Modals & Pins --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; align-items: center; justify-content: center; 
            z-index: 2000; backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease;
        }
        .modal-content {
            background: var(--bg); padding: 30px; border-radius: 30px; 
            width: 90%; max-width: 380px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.3, 0, 0, 1);
        }

        /* Pin Dots */
        .pin-dots { display: flex; gap: 20px; margin-bottom: 50px; justify-content: center; }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; background: #D1D1D6; transition: 0.3s; }
        .pin-dot.filled { background: var(--primary); transform: scale(1.3); }
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px 30px; max-width: 300px; margin: 0 auto; }
        .pin-btn {
            width: 70px; height: 70px; border-radius: 50%; background: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; font-weight: 500; color: var(--text); cursor: pointer;
            box-shadow: var(--shadow); transition: 0.1s;
        }
        .pin-btn:active { background: var(--text); color: white; transform: scale(0.9); }

        /* Color Picker */
        .color-dot {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; transition: 0.2s; margin: 0 5px;
        }
        .color-dot.active { border-color: var(--text); transform: scale(1.1); }

    </style>
</head>
<body>

<div id="loading-screen">
    <div class="loader-ring"></div>
    <p style="margin-top: 15px; font-weight: 600;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<div class="app-container">

    <div id="screen-login" class="screen">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; padding: 20px;">
            <div style="width: 70px; height: 70px; background: var(--primary-grad); border-radius: 22px; margin-bottom: 25px; display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 30px rgba(255, 107, 0, 0.3);">
                <svg width="35" height="35" fill="white" viewBox="0 0 24 24"><path d="M12 2L2 12h3v8h6v-6h2v6h6v-8h3L12 2z"/></svg>
            </div>
            <h1>–í–æ–π—Ç–∏</h1>
            <p style="margin-bottom: 30px;">–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º –≤ BingusBank</p>
            
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å">
            
            <p onclick="forgotPassword()" style="text-align:right; color:var(--primary); font-size:14px; font-weight:600; margin-bottom:30px; cursor:pointer;">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</p>
            
            <button class="btn primary" id="btn-login" onclick="login()">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
            <p onclick="showScreen('screen-reg')" style="text-align:center; margin-top:30px; font-weight:600; cursor:pointer;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span style="color:var(--primary);">–°–æ–∑–¥–∞—Ç—å</span></p>
        </div>
    </div>

    <div id="screen-reg" class="screen">
        <div style="margin-top: 60px;">
            <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
            <p style="margin-bottom: 30px;">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å—á–µ—Ç</p>
            <input type="text" id="reg-name" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è">
            <input type="email" id="reg-email" placeholder="Email">
            <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
            <button class="btn primary" id="btn-reg" onclick="register()">–°–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç</button>
            <p onclick="showScreen('screen-login')" style="text-align:center; cursor:pointer; margin-top:20px; font-weight:600;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</p>
        </div>
    </div>

    <div id="screen-pin" class="screen" style="z-index: 1500; padding-bottom: 0;">
        <div style="flex:1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div style="margin-bottom: 20px; font-size: 40px;">üîí</div>
            <h2 id="pin-title" style="margin-bottom: 10px;">–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</h2>
            <p id="pin-subtitle" style="margin-bottom: 40px;">–í–≤–µ–¥–∏—Ç–µ 4 —Ü–∏—Ñ—Ä—ã</p>
            
            <div class="pin-dots">
                <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
                <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
            </div>

            <div class="pin-pad">
                <div class="pin-btn" onclick="pressPin(1)">1</div><div class="pin-btn" onclick="pressPin(2)">2</div>
                <div class="pin-btn" onclick="pressPin(3)">3</div><div class="pin-btn" onclick="pressPin(4)">4</div>
                <div class="pin-btn" onclick="pressPin(5)">5</div><div class="pin-btn" onclick="pressPin(6)">6</div>
                <div class="pin-btn" onclick="pressPin(7)">7</div><div class="pin-btn" onclick="pressPin(8)">8</div>
                <div class="pin-btn" onclick="pressPin(9)">9</div><div class="pin-btn" style="background:transparent; box-shadow:none; cursor:default"></div>
                <div class="pin-btn" onclick="pressPin(0)">0</div><div class="pin-btn" onclick="pressPin(-1)">‚å´</div>
            </div>
            
            <p onclick="logout()" style="margin-top: 40px; color: var(--danger); font-weight:600; cursor:pointer;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="header">
            <div>
                <p>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ,</p>
                <h2 id="user-name">...</h2>
            </div>
            <div class="user-avatar" onclick="openProfileSettings()">
                <img id="user-avatar-img" src="https://ui-avatars.com/api/?name=User&background=random" alt="Avatar">
            </div>
        </div>

        <p style="padding: 0 5px; margin-bottom: 8px;">–ú–æ–∏ –∫–∞—Ä—Ç—ã</p>
        <div class="cards-wrapper" id="cards-container"></div>
        
        <div style="display:flex; gap:10px; margin: 15px 0;">
             <button class="btn secondary" style="flex:1" onclick="switchTab('transfer')">üì§ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
             <button class="btn secondary" style="flex:1" onclick="showScreen('screen-history')">üïí –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>

        <div class="glass-panel" style="flex:1;">
            <h3 style="margin-bottom: 15px;">–û–ø–µ—Ä–∞—Ü–∏–∏</h3>
            <div id="main-tx-list"></div>
        </div>
    </div>

    <div id="screen-profile-settings" class="screen" style="z-index: 1200;">
        <div onclick="showScreen('screen-main')" style="cursor:pointer; font-weight:700; margin-bottom:20px;">‚Üê –ù–∞–∑–∞–¥</div>
        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
        
        <div style="text-align:center; margin: 30px 0;">
            <div style="width: 100px; height: 100px; margin: 0 auto 15px; border-radius: 50%; overflow:hidden; box-shadow: var(--shadow);">
                <img id="settings-avatar-img" src="" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <p style="font-size: 13px;">–í–≤–µ–¥–∏—Ç–µ URL –∫–∞—Ä—Ç–∏–Ω–∫–∏</p>
        </div>

        <p style="margin-bottom:5px;">–ò–º—è</p>
        <input type="text" id="edit-name" placeholder="–í–∞—à–µ –∏–º—è">
        
        <p style="margin-bottom:5px;">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (URL)</p>
        <input type="text" id="edit-photo-url" placeholder="https://...">

        <button class="btn primary" onclick="saveProfileChanges()" id="btn-save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>

        <div style="margin-top: auto; padding-bottom: 20px;">
            <button class="btn danger" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>
    </div>

    <div id="screen-transfer-menu" class="screen">
        <h1>–ü–µ—Ä–µ–≤–æ–¥—ã</h1>
        <p style="margin-bottom: 25px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±</p>
        
        <div class="glass-panel" onclick="openSelfTransfer()" style="display:flex; align-items:center; cursor:pointer;">
            <div class="tx-icon" style="background:#E3F2FD; color:#2196F3;">üîÑ</div>
            <div><b>–ú–µ–∂–¥—É —Å–≤–æ–∏–º–∏</b><br><span style="font-size:13px; color:gray;">–ù–∞ –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É</span></div>
        </div>

        <div class="glass-panel" onclick="openExternalTransfer('card')" style="display:flex; align-items:center; cursor:pointer;">
            <div class="tx-icon" style="background:#E8F5E9; color:#4CAF50;">üí≥</div>
            <div><b>–ü–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã</b><br><span style="font-size:13px; color:gray;">–ö–ª–∏–µ–Ω—Ç—É –ª—é–±–æ–≥–æ –±–∞–Ω–∫–∞</span></div>
        </div>
        
        <div class="glass-panel" onclick="openExternalTransfer('email')" style="display:flex; align-items:center; cursor:pointer;">
            <div class="tx-icon" style="background:#FFF3E0; color:#FF9800;">üìß</div>
            <div><b>–ü–æ Email</b><br><span style="font-size:13px; color:gray;">–í–Ω—É—Ç—Ä–∏ BingusBank</span></div>
        </div>
    </div>

    <div id="screen-external-transfer" class="screen" style="z-index: 1200;">
        <div onclick="showScreen('screen-transfer-menu')" style="cursor:pointer; font-weight:700; margin-bottom:20px;">‚Üê –ù–∞–∑–∞–¥</div>
        <h2 id="ext-title">–ü–µ—Ä–µ–≤–æ–¥</h2>
        
        <p style="margin-top:20px;">–°–ø–∏—Å–∞—Ç—å —Å:</p>
        <div id="ext-cards-from"></div>

        <p style="margin-top: 15px;" id="ext-input-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</p>
        <input type="text" id="ext-dest">
        
        <p style="margin-top: 5px;">–°—É–º–º–∞:</p>
        <input type="number" id="ext-amount" placeholder="0 ‚ÇΩ">
        
        <div id="user-check-result" style="margin-bottom:15px; font-size:14px; display:none;"></div>

        <button class="btn primary" id="btn-exec-ext" onclick="executeExternalTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
    </div>

    <div id="screen-sbp-scan" class="screen" style="z-index: 2000;">
        <div onclick="stopScannerAndBack()" style="cursor:pointer; font-weight:700; margin-bottom: 20px;">‚Üê –ó–∞–∫—Ä—ã—Ç—å</div>
        <h2>–û–ø–ª–∞—Ç–∞ –ø–æ QR</h2>
        <div id="reader" style="border-radius:20px; overflow:hidden; margin-top:20px;"></div>
        <p style="text-align: center; margin-top: 20px;">–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–æ–¥ –°–ë–ü</p>
    </div>

    <div id="screen-history" class="screen">
        <h1>–ò—Å—Ç–æ—Ä–∏—è</h1>
        <div class="glass-panel" id="full-history-list" style="min-height: 200px;"></div>
    </div>

    <div id="screen-card-detail" class="screen" style="z-index: 1100;">
        <div onclick="showScreen('screen-main')" style="cursor:pointer; font-weight:700; margin-bottom:20px;">‚úï –ó–∞–∫—Ä—ã—Ç—å</div>
        <div id="detail-card-visual" style="margin: 10px 0 30px; transform: scale(1.05);"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <button class="btn secondary" id="btn-block-card" onclick="toggleBlockCard()">üîí –ë–ª–æ–∫</button>
            <button class="btn secondary" onclick="openChangeColorModal()">üé® –î–∏–∑–∞–π–Ω</button>
        </div>

        <div class="glass-panel">
            <h3>–û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Ä—Ç–µ</h3>
            <div id="card-tx-list"></div>
        </div>
    </div>
    
    <div id="screen-self-transfer" class="screen" style="z-index: 1200;">
        <div onclick="showScreen('screen-transfer-menu')" style="cursor:pointer; font-weight:700; margin-bottom:20px;">‚Üê –ù–∞–∑–∞–¥</div>
        <h2>–ú–µ–∂–¥—É —Å–≤–æ–∏–º–∏</h2>
        <p style="margin-top:20px;">–û—Ç–∫—É–¥–∞:</p><div id="self-cards-from"></div>
        <p style="margin-top: 15px;">–ö—É–¥–∞:</p><div id="self-cards-to"></div>
        <input type="number" id="self-amount" placeholder="–°—É–º–º–∞ ‚ÇΩ" style="margin-top:20px;">
        <button class="btn primary" id="btn-exec-self" onclick="executeSelfTransfer()">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
    </div>

</div>

<div class="bottom-nav" id="bottom-nav">
    <div class="nav-item" onclick="switchTab('home', this)">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </div>
    
    <div class="nav-item" onclick="switchTab('transfer', this)">
        <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0020 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 004 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
        <span>–ü–µ—Ä–µ–≤–æ–¥</span>
    </div>
    
    <div class="nav-center-wrapper">
        <div class="nav-center-btn" onclick="startSbpScanner()">
            <svg viewBox="0 0 24 24"><path d="M3 3h6v6H3V3zm2 2v2h2V5H5zm8-2h6v6h-6V3zm2 2v2h2V5h-2zM3 15h6v6H3v-6zm2 2v2h2v-2H5zm8 4h2v2h-2v-2zm-2-4h2v2h-2v-2zm4 0h2v2h-2v-2zm2 2h2v2h-2v-2z"/></svg>
        </div>
    </div>
    
    <div class="nav-item" onclick="switchTab('history', this)">
        <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.97 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
        <span>–ò—Å—Ç–æ—Ä–∏—è</span>
    </div>

    <div class="nav-item" onclick="openIssueModal()">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        <span>–ö–∞—Ä—Ç—ã</span>
    </div>
</div>

<div id="card-modal" class="modal">
    <div class="modal-content">
        <h3>–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∑–∞–π–Ω</p>
        <div style="display:flex; justify-content:center; margin:25px 0;" id="color-picker-issue">
            <div onclick="selectCardColor('issue', this, 'linear-gradient(135deg, #FF6B00, #FF4500)')" class="color-dot active" style="background:linear-gradient(135deg, #FF6B00, #FF4500);"></div>
            <div onclick="selectCardColor('issue', this, 'linear-gradient(135deg, #1C1C1E, #444)')" class="color-dot" style="background:linear-gradient(135deg, #1C1C1E, #444);"></div>
            <div onclick="selectCardColor('issue', this, 'linear-gradient(135deg, #007AFF, #0051A5)')" class="color-dot" style="background:linear-gradient(135deg, #007AFF, #0051A5);"></div>
            <div onclick="selectCardColor('issue', this, 'linear-gradient(135deg, #34C759, #1E8E3E)')" class="color-dot" style="background:linear-gradient(135deg, #34C759, #1E8E3E);"></div>
        </div>
        <button class="btn primary" id="btn-issue" onclick="issueCard()">–í—ã–ø—É—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É</button>
        <p onclick="closeModal('card-modal')" style="margin-top:20px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</p>
    </div>
</div>

<div id="color-modal" class="modal">
    <div class="modal-content">
        <h3>–°–º–µ–Ω–∏—Ç—å –¥–∏–∑–∞–π–Ω</h3>
        <div style="display:flex; justify-content:center; margin:25px 0;" id="color-picker-change">
            <div onclick="selectCardColor('change', this, 'linear-gradient(135deg, #FF6B00, #FF4500)')" class="color-dot active" style="background:linear-gradient(135deg, #FF6B00, #FF4500);"></div>
            <div onclick="selectCardColor('change', this, 'linear-gradient(135deg, #1C1C1E, #444)')" class="color-dot" style="background:linear-gradient(135deg, #1C1C1E, #444);"></div>
            <div onclick="selectCardColor('change', this, 'linear-gradient(135deg, #007AFF, #0051A5)')" class="color-dot" style="background:linear-gradient(135deg, #007AFF, #0051A5);"></div>
            <div onclick="selectCardColor('change', this, 'linear-gradient(135deg, #34C759, #1E8E3E)')" class="color-dot" style="background:linear-gradient(135deg, #34C759, #1E8E3E);"></div>
        </div>
        <button class="btn primary" id="btn-change-color" onclick="saveNewColor()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <p onclick="closeModal('color-modal')" style="margin-top:20px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</p>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (–ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBYAFyV2_WHPWSrL7vgOjvOV8xi7E7tIko",
        authDomain: "bingusbank-589aa.firebaseapp.com",
        projectId: "bingusbank-589aa",
        storageBucket: "bingusbank-589aa.firebasestorage.app",
        messagingSenderId: "111589726196",
        appId: "1:111589726196:web:5efec8b45a2f54d5220ba1"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let myData = null, myCards = [], currentCardId = null;
    let selectedCardFrom = null, selectedCardTo = null;
    let extTransferType = null;
    let tempColorIssue = 'linear-gradient(135deg, #FF6B00, #FF4500)';
    let tempColorChange = 'linear-gradient(135deg, #FF6B00, #FF4500)';
    let html5QrCode = null;
    let sbpData = { termId: "", amount: 0 };
    let pinBuffer = "";
    let pinMode = "create";

    // --- NAVIGATION ---
    function switchTab(tab, el) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        if(el) el.classList.add('active');
        // If clicking transfer from nav, highlight manually
        if (tab === 'transfer') document.querySelectorAll('.nav-item')[1].classList.add('active');
        if (tab === 'home') document.querySelectorAll('.nav-item')[0].classList.add('active');

        if(tab === 'home') showScreen('screen-main');
        if(tab === 'history') { loadFullHistory(); showScreen('screen-history'); }
        if(tab === 'transfer') showScreen('screen-transfer-menu');
    }

    // --- PIN SYSTEM ---
    function checkPinSystem() {
        const savedPin = localStorage.getItem('user_pin');
        pinBuffer = ""; updatePinDots();
        
        if (!savedPin) {
            pinMode = "create";
            document.getElementById('pin-title').innerText = "–°–æ–∑–¥–∞—Ç—å –∫–æ–¥";
            document.getElementById('pin-subtitle').innerText = "–î–ª—è –∑–∞—â–∏—Ç—ã –≤—Ö–æ–¥–∞";
            showScreen('screen-pin');
        } else {
            pinMode = "auth";
            document.getElementById('pin-title').innerText = "–í—Ö–æ–¥";
            document.getElementById('pin-subtitle').innerText = "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞";
            showScreen('screen-pin');
        }
        document.getElementById('loading-screen').style.display = 'none';
    }

    function pressPin(num) {
        if (num === -1) pinBuffer = pinBuffer.slice(0, -1);
        else if (pinBuffer.length < 4) pinBuffer += num;
        
        updatePinDots();
        if (pinBuffer.length === 4) setTimeout(() => processPin(), 100);
    }

    function updatePinDots() {
        for (let i = 0; i < 4; i++) {
            const dot = document.getElementById(`dot-${i}`);
            if (i < pinBuffer.length) dot.classList.add('filled');
            else dot.classList.remove('filled');
        }
    }

    function processPin() {
        if (pinMode === 'create') {
            localStorage.setItem('user_pin', pinBuffer);
            initMainFlow();
        } else if (pinMode === 'auth') {
            if (pinBuffer === localStorage.getItem('user_pin')) initMainFlow();
            else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥");
                pinBuffer = ""; updatePinDots();
                document.querySelectorAll('.pin-dot').forEach(d => {
                    d.style.background = '#FF3B30';
                    setTimeout(() => d.style.background = '', 300);
                });
            }
        }
    }

    // --- DATA LOADING ---
    async function initMainFlow() {
        document.getElementById('loading-screen').style.display = 'flex';
        try {
            const userRef = db.collection('users').doc(auth.currentUser.uid);
            const doc = await userRef.get();
            if (!doc.exists) {
                // –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ, —Å–æ–∑–¥–∞–¥–∏–º
                await userRef.set({ email: auth.currentUser.email, name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", uid: auth.currentUser.uid });
                myData = { email: auth.currentUser.email, name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" };
            } else {
                myData = doc.data();
            }
            
            // Sync Cards
            const cardsSnap = await userRef.collection('cards').get(); 
            myCards = cardsSnap.docs.map(d => ({id: d.id, ...d.data()}));
            myCards.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

            renderMain();
            showScreen('screen-main');
            document.getElementById('bottom-nav').style.display = 'grid'; // Show Nav
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        }
        document.getElementById('loading-screen').style.display = 'none';
    }

    function renderMain() {
        if(!myData) return;
        document.getElementById('user-name').innerText = myData.name;
        // Avatar setup
        const avatarUrl = myData.photoURL || `https://ui-avatars.com/api/?name=${myData.name}&background=FF6B00&color=fff`;
        document.getElementById('user-avatar-img').src = avatarUrl;
        document.getElementById('settings-avatar-img').src = avatarUrl;
        document.getElementById('edit-name').value = myData.name;
        document.getElementById('edit-photo-url').value = myData.photoURL || "";

        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        
        if(myCards.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; width:100%; color:gray;">–ù–µ—Ç –∫–∞—Ä—Ç. –ù–∞–∂–º–∏—Ç–µ "–ù–æ–≤–∞—è"</div>';
        }

        let delay = 0;
        myCards.forEach(card => {
            container.innerHTML += `
                <div class="bank-card animate-fade-in" style="background:${card.color}; opacity:${card.blocked?0.5:1}; animation-delay: ${delay}s" onclick="openCardDetails('${card.id}')">
                    <div style="font-weight:900; font-size:12px; opacity:0.8;">BINGUS ULTRA</div>
                    <div style="font-size:28px; font-weight:800; margin: 15px 0;">${(card.balance || 0).toLocaleString()} ‚ÇΩ</div>
                    <div style="font-family:monospace; opacity:0.9;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.cardNum.slice(-4)}</div>
                </div>`;
            delay += 0.1;
        });
        
        db.collection('users').doc(auth.currentUser.uid).collection('transactions')
          .orderBy('date','desc').limit(5).get()
          .then(snap => renderTxList(snap, 'main-tx-list'));
    }

    function renderTxList(snap, id) {
        const list = document.getElementById(id);
        list.innerHTML = '';
        if(snap.empty) { list.innerHTML = '<p style="text-align:center; color:gray; padding:20px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>'; return; }
        
        let delay = 0;
        snap.forEach(doc => {
            const tx = doc.data();
            const isInc = tx.type !== 'outcome' && tx.type !== 'self';
            const icon = isInc ? '‚¨áÔ∏è' : '‚ÜóÔ∏è';
            const color = isInc ? 'var(--success)' : 'var(--text)';
            const sign = isInc ? '+' : '-';
            
            list.innerHTML += `
            <div class="tx-item" style="animation-delay:${delay}s">
                <div style="display:flex; align-items:center;">
                    <div class="tx-icon">${icon}</div>
                    <div>
                        <div style="font-weight:600; font-size:15px;">${tx.title}</div>
                        <div style="font-size:12px; color:gray;">${new Date(tx.date).toLocaleDateString()}</div>
                    </div>
                </div>
                <div style="font-weight:700; color:${color};">${sign} ${tx.amount.toLocaleString()} ‚ÇΩ</div>
            </div>`;
            delay += 0.05;
        });
    }

    async function loadFullHistory() {
        const snap = await db.collection('users').doc(auth.currentUser.uid).collection('transactions').orderBy('date','desc').limit(50).get();
        renderTxList(snap, 'full-history-list');
    }

    // --- PROFILE MANAGEMENT ---
    function openProfileSettings() { showScreen('screen-profile-settings'); }
    
    async function saveProfileChanges() {
        const newName = document.getElementById('edit-name').value;
        const newPhoto = document.getElementById('edit-photo-url').value;
        if(!newName) return alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");

        setBtnLoading('btn-save-profile', true, '');
        try {
            await db.collection('users').doc(auth.currentUser.uid).update({ name: newName, photoURL: newPhoto });
            // Also update Auth profile
            await auth.currentUser.updateProfile({ displayName: newName, photoURL: newPhoto });
            
            myData.name = newName; 
            myData.photoURL = newPhoto;
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            renderMain();
            showScreen('screen-main');
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
        setBtnLoading('btn-save-profile', false, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
    }

    function forgotPassword() {
        const email = document.getElementById('login-email').value;
        if(!email) return alert("–í–≤–µ–¥–∏—Ç–µ Email, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å");
        auth.sendPasswordResetEmail(email)
            .then(() => alert("–°—Å—ã–ª–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ " + email))
            .catch(e => alert(e.message));
    }

    // --- TRANSFERS & VALIDATION ---
    function openExternalTransfer(type) {
        extTransferType = type;
        showScreen('screen-external-transfer');
        document.getElementById('user-check-result').style.display = 'none';
        
        document.getElementById('ext-title').innerText = type === 'card' ? "–ü–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã" : "–ü–æ Email";
        document.getElementById('ext-input-label').innerText = type === 'card' ? "–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—è (16 —Ü–∏—Ñ—Ä):" : "Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è:";
        document.getElementById('ext-dest').placeholder = type === 'card' ? "0000 0000 0000 0000" : "example@mail.ru";
        document.getElementById('ext-dest').type = type === 'card' ? "tel" : "email";
        renderCardSelection('ext-cards-from', c => selectedCardFrom = c);
    }

    async function executeExternalTransfer() {
        let dest = document.getElementById('ext-dest').value.trim();
        const val = parseInt(document.getElementById('ext-amount').value);

        if(!selectedCardFrom) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É —Å–ø–∏—Å–∞–Ω–∏—è");
        if(!dest || isNaN(val) || val <= 0) return alert("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É–º–º—É –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã");
        if(selectedCardFrom.balance < val) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

        // Clean Card format
        if (extTransferType === 'card') dest = dest.replace(/\D/g, '');
        if (extTransferType === 'card' && dest.length !== 16) return alert("–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 16 —Ü–∏—Ñ—Ä");

        setBtnLoading('btn-exec-ext', true, '');
        const resLabel = document.getElementById('user-check-result');
        resLabel.style.display = 'block';
        resLabel.innerText = "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è...";
        resLabel.style.color = "gray";

        try {
            const batch = db.batch();
            const uRef = db.collection('users').doc(auth.currentUser.uid);
            let foundReceiver = false;

            if (extTransferType === 'email') {
                const snapshot = await db.collection('users').where('email', '==', dest).limit(1).get();
                if (!snapshot.empty) {
                    foundReceiver = true;
                    const receiver = snapshot.docs[0];
                    const rCards = await receiver.ref.collection('cards').limit(1).get();
                    if (!rCards.empty) {
                         const rCard = rCards.docs[0];
                         batch.update(rCard.ref, { balance: firebase.firestore.FieldValue.increment(val) });
                         batch.set(receiver.ref.collection('transactions').doc(), {
                             amount: val, title: "–í—Ö–æ–¥—è—â–∏–π –ø–µ—Ä–µ–≤–æ–¥", type: "income", date: Date.now(), cardId: rCard.id
                         });
                    }
                }
            } else if (extTransferType === 'card') {
                // –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–∞—Ä—Ç–∞–º (CollectionGroup). 
                // –í–ù–ò–ú–ê–ù–ò–ï: –¢—Ä–µ–±—É–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ Firestore. –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, –∑–∞–ø—Ä–æ—Å —É–ø–∞–¥–µ—Ç –≤ catch.
                // –ú—ã –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏. –ï—Å–ª–∏ —É–ø–∞–¥–µ—Ç - –∏–º–∏—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–≤–æ–¥ –≤–æ –≤–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫.
                try {
                    const cardsQuery = await db.collectionGroup('cards').where('cardNum', '==', dest).limit(1).get();
                    if(!cardsQuery.empty) {
                        foundReceiver = true;
                        const rCardDoc = cardsQuery.docs[0];
                        // –ù–∞–π—Ç–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (Parent doc -> Parent collection -> Parent doc)
                        // path: users/{uid}/cards/{cardId}
                        const rUid = rCardDoc.ref.parent.parent.id;
                        
                        batch.update(rCardDoc.ref, { balance: firebase.firestore.FieldValue.increment(val) });
                        batch.set(db.collection('users').doc(rUid).collection('transactions').doc(), {
                             amount: val, title: "–í—Ö–æ–¥—è—â–∏–π –ø–µ—Ä–µ–≤–æ–¥", type: "income", date: Date.now(), cardId: rCardDoc.id
                        });
                    }
                } catch (err) {
                    console.warn("Index missing for global card search. Simulating external transfer.");
                    // –ò–Ω–¥–µ–∫—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –≤–æ "–≤–Ω–µ—à–Ω–µ–º –±–∞–Ω–∫–µ" - –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å—ã–≤–∞–µ–º
                }
            }

            // SENDER logic
            batch.update(uRef.collection('cards').doc(selectedCardFrom.id), { balance: firebase.firestore.FieldValue.increment(-val) });
            batch.set(uRef.collection('transactions').doc(), { 
                amount: val, 
                title: foundReceiver ? `–ü–µ—Ä–µ–≤–æ–¥: ${dest}` : `–ü–µ—Ä–µ–≤–æ–¥ –≤–æ –≤–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫`, 
                type: 'outcome', 
                date: Date.now(), 
                cardId: selectedCardFrom.id 
            });

            await batch.commit();
            
            if(foundReceiver) alert("‚úÖ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω! –ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–µ–Ω.");
            else if(extTransferType === 'card') alert("–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è.");
            else alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–ø–∏—Å–∞–Ω—ã (—Ç–µ—Å—Ç).");

            location.reload();

        } catch(e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞: " + e.message);
            setBtnLoading('btn-exec-ext', false, '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞');
        }
    }

    // --- OTHER ACTIONS ---
    async function issueCard() {
        setBtnLoading('btn-issue', true, '');
        try {
            await db.collection('users').doc(auth.currentUser.uid).collection('cards').add({
                balance: 0,
                cardNum: "4400" + Math.random().toString().slice(2,14),
                color: tempColorIssue,
                blocked: false,
                createdAt: Date.now()
            });
            closeModal('card-modal');
            initMainFlow();
        } catch(e) { alert("–û—à–∏–±–∫–∞"); }
        setBtnLoading('btn-issue', false, '–í—ã–ø—É—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É');
    }

    async function openCardDetails(id) {
        currentCardId = id;
        let card = myCards.find(c => c.id === id);
        showScreen('screen-card-detail');
        document.getElementById('detail-card-visual').innerHTML = `<div class="bank-card" style="background:${card.color}; margin:auto;">
            <div style="font-weight:900;">BINGUS ULTRA</div>
            <div style="font-size:28px; font-weight:800;">${card.balance.toLocaleString()} ‚ÇΩ</div>
            <div style="font-family:monospace;">${card.cardNum.replace(/(\d{4})/g, '$1 ')}</div>
        </div>`;
        document.getElementById('btn-block-card').innerText = card.blocked ? "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "üîí –ë–ª–æ–∫";
        const snap = await db.collection('users').doc(auth.currentUser.uid).collection('transactions').where('cardId','==',id).orderBy('date','desc').limit(20).get();
        renderTxList(snap, 'card-tx-list');
    }

    // --- HELPERS ---
    function renderCardSelection(id, onSelect) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        const validCards = myCards.filter(c => !c.blocked);
        if(validCards.length === 0) el.innerHTML = "<small>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç</small>";

        validCards.forEach(c => {
            const div = document.createElement('div');
            div.style.padding='15px'; div.style.marginBottom='10px'; div.style.background='white'; 
            div.style.borderRadius='16px'; div.style.border='1px solid transparent'; div.style.cursor='pointer';
            div.style.display='flex'; div.style.justifyContent='space-between'; div.style.boxShadow='var(--shadow)';
            
            div.innerHTML = `<span>‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${c.cardNum.slice(-4)}</span> <b>${c.balance.toLocaleString()} ‚ÇΩ</b>`;
            div.onclick = () => { 
                Array.from(el.children).forEach(i=>i.style.border='1px solid transparent'); 
                div.style.border='2px solid var(--primary)'; 
                onSelect(c); 
            };
            el.appendChild(div);
        });
    }

    function setBtnLoading(id, load, text) {
        const b = document.getElementById(id);
        if(!b) return;
        if(load) { b.disabled = true; b.innerHTML = '<div class="btn-loader"></div>'; } 
        else { b.disabled = false; b.innerHTML = text; }
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'screen-main') {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.nav-item')[0].classList.add('active');
        }
    }

    // --- AUTH & MISC ---
    function register() {
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-password').value;
        if(!name || pass.length < 6) return alert("–ü–∞—Ä–æ–ª—å –º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤");
        setBtnLoading('btn-reg', true, '');
        auth.createUserWithEmailAndPassword(email, pass).then(res => {
            // Initial setup
            db.collection('users').doc(res.user.uid).set({ uid: res.user.uid, name, email, photoURL: "" });
            db.collection('users').doc(res.user.uid).collection('cards').add({
                cardNum: Array.from({length:16},()=>Math.floor(Math.random()*10)).join(''),
                color: "linear-gradient(135deg, #FF6B00, #FF4500)", balance: 10000, blocked: false, createdAt: Date.now()
            });
            location.reload();
        }).catch(e => { alert(e.message); setBtnLoading('btn-reg', false, '–°–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç'); });
    }

    function login() { 
        setBtnLoading('btn-login', true, '');
        auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
        .catch(e => { alert(e.message); setBtnLoading('btn-login', false, '–í–æ–π—Ç–∏'); });
    }

    function logout() { localStorage.removeItem('user_pin'); auth.signOut().then(()=>location.reload()); }
    
    // --- SBP ---
    function startSbpScanner() {
        showScreen('screen-sbp-scan');
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => {
            if (decodedText) {
                // Mock logic for scanning
                alert("QR —Å—á–∏—Ç–∞–Ω: " + decodedText);
                html5QrCode.stop();
                showScreen('screen-main');
            }
        });
    }

    function openSelfTransfer() { showScreen('screen-self-transfer'); renderCardSelection('self-cards-from', c=>selectedCardFrom=c); renderCardSelection('self-cards-to', c=>selectedCardTo=c); }
    async function executeSelfTransfer() {
        const val = parseInt(document.getElementById('self-amount').value);
        if(!selectedCardFrom || !selectedCardTo || val<=0) return alert("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö");
        setBtnLoading('btn-exec-self', true, '');
        try {
            const batch = db.batch();
            const uRef = db.collection('users').doc(auth.currentUser.uid);
            batch.update(uRef.collection('cards').doc(selectedCardFrom.id), { balance: firebase.firestore.FieldValue.increment(-val) });
            batch.update(uRef.collection('cards').doc(selectedCardTo.id), { balance: firebase.firestore.FieldValue.increment(val) });
            batch.set(uRef.collection('transactions').doc(), { title: "–ú–µ–∂–¥—É —Å–≤–æ–∏–º–∏", amount: val, type: "self", date: Date.now(), cardId: selectedCardFrom.id });
            await batch.commit(); alert("–ì–æ—Ç–æ–≤–æ"); location.reload();
        } catch(e) { alert("–û—à–∏–±–∫–∞"); setBtnLoading('btn-exec-self', false, '–ü–µ—Ä–µ–≤–µ—Å—Ç–∏'); }
    }

    function stopScannerAndBack() { if(html5QrCode) html5QrCode.stop().catch(()=>{}); showScreen('screen-main'); }
    function selectCardColor(context, el, color) {
        const container = context === 'issue' ? 'color-picker-issue' : 'color-picker-change';
        document.querySelectorAll(`#${container} .color-dot`).forEach(d => d.classList.remove('active'));
        el.classList.add('active');
        if (context === 'issue') tempColorIssue = color; else tempColorChange = color;
    }
    async function toggleBlockCard() { await db.collection('users').doc(auth.currentUser.uid).collection('cards').doc(currentCardId).update({blocked: !myCards.find(c=>c.id===currentCardId).blocked}); location.reload(); }
    async function saveNewColor() { await db.collection('users').doc(auth.currentUser.uid).collection('cards').doc(currentCardId).update({color: tempColorChange}); location.reload(); }
    function openChangeColorModal() { document.getElementById('color-modal').style.display='flex'; }
    function openIssueModal() { document.getElementById('card-modal').style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }

    // Init
    auth.onAuthStateChanged(u => { if(u) checkPinSystem(); else { document.getElementById('loading-screen').style.display='none'; showScreen('screen-login'); } });
</script>
</body>
</html>
