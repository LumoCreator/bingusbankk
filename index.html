<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingusBank ‚Äî –ú–æ–±–∏–ª—å–Ω—ã–π –±–∞–Ω–∫–∏–Ω–≥</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∫–æ–Ω—Å–æ–ª–∏ -->
    <script src="https://cdn.skypack.dev"></script>
    <script src="https://cdnjs.cloudflare.com"></script>
    <script src="https://unpkg.com"></script>
    <style>
        :root { --orange-main: #FF6B00; }
        .bg-orange-bingus { background-color: var(--orange-main); }
        .text-orange-bingus { color: var(--orange-main); }
        .border-orange-bingus { border-color: var(--orange-main); }
        .card-gradient { background: linear-gradient(135deg, #FF6B00 0%, #FF9E5E 100%); }
        .blur-data { filter: blur(5px); transition: 0.3s; cursor: pointer; }
        .unblur { filter: blur(0) !important; }
        body { background-color: #F8F9FA; font-family: sans-serif; overflow-x: hidden; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .active { display: flex; }
        .animate-bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); } 50% { transform: none; animation-timing-function: cubic-bezier(0,0,0.2,1); } }
    </style>
</head>
<body>

<div id="app">
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loader" class="fixed inset-0 z-[1000] flex items-center justify-center bg-white">
        <div class="animate-bounce text-orange-bingus font-bold text-3xl">BingusBank...</div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω—ã –í—Ö–æ–¥–∞ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md border border-gray-100">
            <h1 class="text-4xl font-black text-center mb-8 text-orange-bingus tracking-tighter">BingusBank</h1>
            
            <div id="login-form">
                <input type="email" id="login-email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" class="w-full p-4 mb-4 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-4 mb-6 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-orange-500">
                <button onclick="handleLogin()" class="w-full bg-orange-bingus text-white py-4 rounded-full font-bold shadow-lg shadow-orange-200 hover:scale-[1.02] transition-transform">–í–æ–π—Ç–∏</button>
                <p class="text-center mt-6 text-gray-500">–í–ø–µ—Ä–≤—ã–µ —É –Ω–∞—Å? <span onclick="toggleAuth(true)" class="text-orange-bingus cursor-pointer font-bold border-b-2 border-orange-200">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</span></p>
            </div>

            <div id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="–í–∞—à–µ –ò–º—è" class="w-full p-4 mb-4 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-orange-500">
                <input type="email" id="reg-email" placeholder="–ü–æ—á—Ç–∞" class="w-full p-4 mb-4 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="reg-pass" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full p-4 mb-6 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-orange-500">
                <button onclick="handleRegister()" class="w-full bg-orange-bingus text-white py-4 rounded-full font-bold shadow-lg shadow-orange-200 hover:scale-[1.02] transition-transform">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <p class="text-center mt-6 text-gray-500">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span onclick="toggleAuth(false)" class="text-orange-bingus cursor-pointer font-bold border-b-2 border-orange-200">–í–æ–π—Ç–∏</span></p>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="main-screen" class="hidden max-w-6xl mx-auto p-4 lg:p-10">
        <header class="flex justify-between items-center mb-10">
            <div>
                <p class="text-gray-400 font-medium">–í–∞—à –∫–æ—à–µ–ª–µ–∫,</p>
                <h1 id="user-name-display" class="text-3xl font-black text-gray-800">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            </div>
            <button onclick="handleLogout()" class="bg-white text-gray-700 px-8 py-3 rounded-full font-bold shadow-sm hover:bg-red-50 hover:text-red-500 transition-colors">–í—ã–π—Ç–∏</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <!-- –ö–∞—Ä—Ç–∞ –∏ –ë–∞–ª–∞–Ω—Å -->
            <div class="lg:col-span-2">
                <div class="card-gradient p-10 rounded-[3rem] text-white shadow-2xl relative overflow-hidden mb-10 min-h-[260px] flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-2xl font-black italic tracking-tighter">BINGUS</span>
                            <p class="text-xs opacity-70 uppercase tracking-widest mt-1">Premium Card</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-2xl backdrop-blur-md">
                            <img src="https://upload.wikimedia.org" class="h-6">
                        </div>
                    </div>
                    
                    <div>
                        <p id="card-number" class="text-2xl sm:text-3xl tracking-[0.2em] font-mono blur-data mb-6">0000 0000 0000 0000</p>
                        <div class="flex gap-10 items-end">
                            <div>
                                <p class="text-[10px] opacity-60 uppercase mb-1">–°—Ä–æ–∫</p>
                                <p id="card-date" class="font-bold blur-data">12/28</p>
                            </div>
                            <div>
                                <p class="text-[10px] opacity-60 uppercase mb-1">CVV</p>
                                <p id="card-cvv" class="font-bold blur-data">***</p>
                            </div>
                            <div class="ml-auto text-right">
                                <p class="text-[10px] opacity-60 mb-1">–ë–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞</p>
                                <p id="balance-display" class="text-4xl font-black">0.00 ‚ÇΩ</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="showCardDetails()" class="absolute top-10 right-24 bg-black/10 hover:bg-black/20 px-4 py-1 rounded-full text-[10px] uppercase font-bold transition-all">–ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="grid grid-cols-3 gap-6">
                    <button onclick="openModal('transfer-modal')" class="bg-white p-6 rounded-[2rem] shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all group text-center">
                        <div class="bg-orange-50 w-16 h-16 rounded-3xl flex items-center justify-center mx-auto mb-4 group-hover:bg-orange-bingus transition-colors">
                            <span class="text-3xl group-hover:scale-110 transition-transform">üí∏</span>
                        </div>
                        <span class="text-sm font-bold text-gray-700">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</span>
                    </button>
                    <button onclick="openModal('request-modal')" class="bg-white p-6 rounded-[2rem] shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all group text-center">
                        <div class="bg-orange-50 w-16 h-16 rounded-3xl flex items-center justify-center mx-auto mb-4 group-hover:bg-orange-bingus transition-colors">
                            <span class="text-3xl group-hover:scale-110 transition-transform">üì•</span>
                        </div>
                        <span class="text-sm font-bold text-gray-700">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</span>
                    </button>
                    <button onclick="openModal('sbp-modal'); startScanner();" class="bg-white p-6 rounded-[2rem] shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all group text-center">
                        <div class="bg-orange-50 w-16 h-16 rounded-3xl flex items-center justify-center mx-auto mb-4 group-hover:bg-orange-bingus transition-colors">
                            <span class="text-3xl group-hover:scale-110 transition-transform">ü§≥</span>
                        </div>
                        <span class="text-sm font-bold text-gray-700">–°–ë–ü</span>
                    </button>
                </div>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è -->
            <div class="bg-white rounded-[3rem] p-8 shadow-sm border border-gray-50 h-[600px] flex flex-col">
                <h3 class="text-2xl font-black mb-8 text-gray-800">–ò—Å—Ç–æ—Ä–∏—è</h3>
                <div id="history-list" class="space-y-4 overflow-y-auto flex-1 pr-2 custom-scrollbar">
                    <p class="text-gray-300 text-center py-10 italic">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∏ (—Ç–µ –∂–µ, –Ω–æ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º) -->
<div id="transfer-modal" class="modal">
    <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-sm m-4 shadow-2xl">
        <h3 class="text-2xl font-black mb-6 text-gray-800">–ü–µ—Ä–µ–≤–æ–¥</h3>
        <input type="text" id="target-card" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏–ª–∏ Email" class="w-full p-4 mb-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-orange-500">
        <input type="number" id="transfer-amount" placeholder="–°—É–º–º–∞ ‚ÇΩ" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-orange-500">
        <button onclick="confirmTransfer()" class="w-full bg-orange-bingus text-white py-4 rounded-full font-bold shadow-lg shadow-orange-100">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button onclick="closeModal('transfer-modal')" class="w-full mt-4 text-gray-400 font-bold text-sm">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<div id="request-modal" class="modal">
    <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-sm m-4 text-center relative shadow-2xl">
        <button onclick="closeModal('request-modal')" class="absolute top-6 right-6 text-gray-300 text-3xl font-light hover:text-orange-500">√ó</button>
        <h3 class="text-2xl font-black mb-6 text-gray-800">–ó–∞–ø—Ä–æ—Å –¥–µ–Ω–µ–≥</h3>
        <div id="request-input-step">
            <input type="number" id="req-amount" placeholder="–°–∫–æ–ª—å–∫–æ ‚ÇΩ?" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-orange-500 text-center text-xl font-bold">
            <button onclick="generateRequestQR()" class="w-full bg-orange-bingus text-white py-4 rounded-full font-bold shadow-lg shadow-orange-100">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR</button>
        </div>
        <div id="request-qr-step" class="hidden">
            <div id="qrcode" class="flex justify-center mb-6 p-4 bg-white rounded-3xl border-2 border-orange-50"></div>
            <p class="text-gray-400 text-sm mb-6 px-4">–ü—É—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥ –≤ —Ä–∞–∑–¥–µ–ª–µ –°–ë–ü</p>
            <button onclick="closeModal('request-modal')" class="w-full bg-gray-100 text-gray-600 py-4 rounded-full font-bold">–ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>
</div>

<div id="sbp-modal" class="modal">
    <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-sm m-4 shadow-2xl text-center">
        <h3 class="text-2xl font-black mb-6 text-gray-800 italic">BINGUS <span class="text-orange-bingus">–°–ë–ü</span></h3>
        <div id="reader" class="overflow-hidden rounded-3xl border-4 border-orange-50 mb-4 bg-gray-50"></div>
        <div id="sbp-confirm" class="hidden animate-in fade-in duration-500">
            <p class="text-gray-400 mb-1">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</p>
            <p id="sbp-target-name" class="font-black text-xl mb-4">-</p>
            <div class="bg-orange-50 p-6 rounded-3xl mb-6">
                <p class="text-3xl font-black text-orange-bingus" id="sbp-amount-display">0 ‚ÇΩ</p>
            </div>
            <button id="sbp-pay-btn" class="w-full bg-orange-bingus text-white py-4 rounded-full font-bold shadow-lg">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ</button>
        </div>
        <button onclick="stopScanner(); closeModal('sbp-modal')" class="mt-6 text-gray-300 font-bold text-xs tracking-widest uppercase">–ó–∞–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
    </div>
</div>

<div id="receipt-modal" class="modal">
    <div class="bg-white p-10 rounded-[3rem] w-full max-w-xs m-4 text-center shadow-2xl border-b-8 border-orange-500">
        <div class="w-20 h-20 bg-orange-500 text-white rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-xl shadow-orange-200">‚úì</div>
        <h3 class="text-2xl font-black mb-2 text-gray-800">–£—Å–ø–µ—Ö!</h3>
        <p id="receipt-details" class="text-gray-500 mb-8 font-medium"></p>
        <button onclick="closeModal('receipt-modal')" class="w-full bg-gray-800 text-white py-4 rounded-2xl font-black hover:bg-black transition-colors">–û–¢–õ–ò–ß–ù–û</button>
    </div>
</div>

<script type="module">
    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ò–ú–ü–û–†–¢–´ (CORS Friendly)
    import { initializeApp } from "https://www.gstatic.com";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com";
    import { getDatabase, ref, set, get, update, onValue, push } from "https://www.gstatic.com";

    const firebaseConfig = {
        apiKey: "AIzaSyDw7fAK6C-HecRqdilBRDmgEcYUgZ8K8Y8",
        authDomain: "bingusbank-e34f4.firebaseapp.com",
        databaseURL: "https://bingusbank-e34f4-default-rtdb.firebaseio.com",
        projectId: "bingusbank-e34f4",
        storageBucket: "bingusbank-e34f4.firebasestorage.app",
        messagingSenderId: "935491412417",
        appId: "1:935491412417:web:c65608262025c5769dcf40"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // –§—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    window.toggleAuth = (isReg) => {
        document.getElementById('login-form').classList.toggle('hidden', isReg);
        document.getElementById('register-form').classList.toggle('hidden', !isReg);
    };

    window.openModal = (id) => {
        document.getElementById(id).classList.add('active');
    };

    window.closeModal = (id) => {
        document.getElementById(id).classList.remove('active');
        if(id === 'sbp-modal') stopScanner();
        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∑–∞–ø—Ä–æ—Å–∞
        if(id === 'request-modal') {
            document.getElementById('request-input-step').classList.remove('hidden');
            document.getElementById('request-qr-step').classList.add('hidden');
        }
    };

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    window.handleRegister = async () => {
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;

        if(!name || !email || pass.length < 6) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–ø–∞—Ä–æ–ª—å –æ—Ç 6 –∑–Ω–∞–∫–æ–≤)");

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
            const user = userCredential.user;
            
            const cardNum = Array.from({length: 16}, () => Math.floor(Math.random() * 10)).join('').replace(/(.{4})/g, '$1 ').trim();
            const cvv = Math.floor(Math.random() * 899) + 100;
            
            const userData = {
                name: name,
                email: email,
                balance: 5000, 
                card: cardNum,
                cvv: cvv,
                expiry: "10/29"
            };

            await set(ref(db, 'users/' + user.uid), userData);
            await set(ref(db, 'cards/' + cardNum.replace(/\s/g, '')), user.uid);
            await set(ref(db, 'emails/' + email.replace(/\./g, ',')), user.uid);
            
        } catch (e) { alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + e.message); }
    };

    // –í—Ö–æ–¥
    window.handleLogin = () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        signInWithEmailAndPassword(auth, email, pass).catch(e => alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"));
    };

    window.handleLogout = () => signOut(auth);

    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    onAuthStateChanged(auth, (user) => {
        const loader = document.getElementById('loader');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');

        if (user) {
            onValue(ref(db, 'users/' + user.uid), (snapshot) => {
                const data = snapshot.val();
                if(!data) return;
                
                document.getElementById('user-name-display').innerText = data.name;
                document.getElementById('balance-display').innerText = data.balance.toLocaleString('ru-RU') + " ‚ÇΩ";
                document.getElementById('card-number').innerText = data.card;
                document.getElementById('card-date').innerText = data.expiry;
                document.getElementById('card-cvv').innerText = data.cvv;
                
                loadHistory(user.uid);
                loader.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                authScreen.classList.add('hidden');
                mainScreen.classList.remove('hidden');
            });
        } else {
            loader.style.display = 'none';
            mainScreen.classList.add('hidden');
            authScreen.classList.remove('hidden');
        }
    });

    // –ü–æ–∫–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã
    window.showCardDetails = () => {
        const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º:");
        if (pass) {
            document.querySelectorAll('.blur-data').forEach(el => el.classList.add('unblur'));
            setTimeout(() => {
                document.querySelectorAll('.blur-data').forEach(el => el.classList.remove('unblur'));
            }, 8000);
        }
    };

    // –ü–µ—Ä–µ–≤–æ–¥
    window.confirmTransfer = async () => {
        const targetStr = document.getElementById('target-card').value.replace(/\s/g, '');
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        const currentUser = auth.currentUser;

        if(!amount || amount <= 0) return alert("–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É");
        
        try {
            let targetUid = null;
            const snapCard = await get(ref(db, 'cards/' + targetStr));
            if(snapCard.exists()) targetUid = snapCard.val();
            else {
                const snapEmail = await get(ref(db, 'emails/' + targetStr.replace(/\./g, ',')));
                if(snapEmail.exists()) targetUid = snapEmail.val();
            }

            if(!targetUid) throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ BingusBank");
            if(targetUid === currentUser.uid) throw new Error("–°–∞–º–æ–º—É —Å–µ–±–µ? –°–µ—Ä—å–µ–∑–Ω–æ?");

            const mySnap = await get(ref(db, 'users/' + currentUser.uid));
            const myData = mySnap.val();
            if(myData.balance < amount) throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ë–∏–Ω–≥—É—Å-–∫–æ–∏–Ω–æ–≤");

            const targetSnap = await get(ref(db, 'users/' + targetUid));
            const targetData = targetSnap.val();

            // –ü—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–≤–æ–¥–∞
            await update(ref(db, 'users/' + currentUser.uid), { balance: myData.balance - amount });
            await update(ref(db, 'users/' + targetUid), { balance: targetData.balance + amount });

            // –ó–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏
            const log = { 
                amount, 
                from: myData.name, 
                to: targetData.name, 
                date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + ' ' + new Date().toLocaleDateString() 
            };
            const tKey = push(ref(db, 'history')).key;
            await set(ref(db, `history/${currentUser.uid}/${tKey}`), { ...log, type: 'out' });
            await set(ref(db, `history/${targetUid}/${tKey}`), { ...log, type: 'in' });

            closeModal('transfer-modal');
            showReceipt(`–ü–µ—Ä–µ–≤–æ–¥ ${amount} ‚ÇΩ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ${targetData.name}`);
        } catch (e) { alert(e.message); }
    };

    // QR –ó–∞–ø—Ä–æ—Å
    window.generateRequestQR = () => {
        const amount = document.getElementById('req-amount').value;
        if(!amount) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
        
        const uid = auth.currentUser.uid;
        const qrData = JSON.stringify({ uid, amount, name: document.getElementById('user-name-display').innerText });
        
        document.getElementById('request-input-step').classList.add('hidden');
        document.getElementById('request-qr-step').classList.remove('hidden');
        
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { 
            text: qrData, 
            width: 180, 
            height: 180,
            colorDark : "#FF6B00",
            colorLight : "#ffffff"
        });
    };

    // –°–ë–ü –°–∫–∞–Ω–µ—Ä
    let html5QrCode;
    window.startScanner = () => {
        document.getElementById('reader').classList.remove('hidden');
        document.getElementById('sbp-confirm').classList.add('hidden');
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                try {
                    const data = JSON.parse(decodedText);
                    if(data.uid && data.amount) {
                        stopScanner();
                        document.getElementById('reader').classList.add('hidden');
                        document.getElementById('sbp-confirm').classList.remove('hidden');
                        document.getElementById('sbp-target-name').innerText = data.name;
                        document.getElementById('sbp-amount-display').innerText = data.amount + " ‚ÇΩ";
                        document.getElementById('sbp-pay-btn').onclick = () => executeSBP(data.uid, data.amount, data.name);
                    }
                } catch(e) { console.log("QR –Ω–µ –æ—Ç –±–∞–Ω–∫–∞"); }
            }
        ).catch(err => alert("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"));
    };

    window.stopScanner = () => { 
        if(html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => { html5QrCode.clear(); });
        }
    };

    async function executeSBP(targetUid, amount, targetName) {
        amount = parseFloat(amount);
        const currentUser = auth.currentUser;
        try {
            const mySnap = await get(ref(db, 'users/' + currentUser.uid));
            const myData = mySnap.val();
            if(myData.balance < amount) throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

            const targetSnap = await get(ref(db, 'users/' + targetUid));
            const targetData = targetSnap.val();

            await update(ref(db, 'users/' + currentUser.uid), { balance: myData.balance - amount });
            await update(ref(db, 'users/' + targetUid), { balance: targetData.balance + amount });

            const log = { 
                amount, 
                from: myData.name, 
                to: targetName, 
                date: "–°–ë–ü " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
            };
            const tKey = push(ref(db, 'history')).key;
            await set(ref(db, `history/${currentUser.uid}/${tKey}`), { ...log, type: 'out' });
            await set(ref(db, `history/${targetUid}/${tKey}`), { ...log, type: 'in' });

            closeModal('sbp-modal');
            showReceipt(`–û–ø–ª–∞—Ç–∞ –°–ë–ü –Ω–∞ —Å—É–º–º—É ${amount} ‚ÇΩ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞`);
        } catch(e) { alert(e.message); }
    }

    function showReceipt(text) {
        document.getElementById('receipt-details').innerText = text;
        openModal('receipt-modal');
    }

    function loadHistory(uid) {
        onValue(ref(db, `history/${uid}`), (snap) => {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            const data = snap.val();
            if(!data) {
                list.innerHTML = '<p class="text-gray-300 text-center py-10 italic">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                return;
            }
            Object.values(data).reverse().forEach(t => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-white shadow-sm";
                const isOut = t.type === 'out';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${isOut ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'} flex items-center justify-center font-bold">
                            ${isOut ? '‚Üì' : '‚Üë'}
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${isOut ? '–ü–µ—Ä–µ–≤–æ–¥: ' + t.to : '–í—Ö–æ–¥—è—â–∏–π: ' + t.from}</p>
                            <p class="text-[10px] text-gray-400 uppercase font-medium">${t.date}</p>
                        </div>
                    </div>
                    <p class="font-black ${isOut ? 'text-gray-800' : 'text-green-600'}">
                        ${isOut ? '-' : '+'}${t.amount.toLocaleString()} ‚ÇΩ
                    </p>
                `;
                list.appendChild(item);
            });
        });
    }
</script>
</body>
</html>
