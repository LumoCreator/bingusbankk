<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingusBank - твой пес помощник!</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #FF6B00;
            --primary-dark: #E56000;
            --bg: #F2F3F7;
            --white: #FFFFFF;
            --text: #1C1C1E;
            --gray: #8E8E93;
            --success: #34C759;
            --danger: #FF3B30;
            --card-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        body { background-color: #000; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }

        .app-container { width: 100%; max-width: 420px; height: 100vh; max-height: 850px; position: relative; background: var(--bg); overflow: hidden; border-radius: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }

        .screen { padding: 25px; display: none; flex-direction: column; width: 100%; height: 100%; overflow-y: auto; position: absolute; background: var(--bg); }
        .screen.active { display: flex; animation: screenIn 0.5s ease forwards; }

        @keyframes screenIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        input { width: 100%; padding: 20px; margin-bottom: 15px; border: 1px solid #E5E5EA; border-radius: 20px; font-size: 17px; outline: none; background: var(--white); }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255,107,0,0.1); }

        .btn { width: 100%; padding: 20px; background: var(--primary); color: white; border: none; border-radius: 22px; font-size: 17px; font-weight: 700; cursor: pointer; box-shadow: 0 10px 20px rgba(255,107,0,0.2); }
        .btn:active { transform: scale(0.97); }
        .btn-link { background: none; border: none; color: var(--primary); font-weight: 600; cursor: pointer; padding: 10px; }

        .cards-slider { display: flex; overflow-x: auto; gap: 15px; padding: 10px 5px 30px 5px; scrollbar-width: none; }
        .cards-slider::-webkit-scrollbar { display: none; }

        .bank-card {
            min-width: 310px; height: 190px; border-radius: 28px; padding: 25px; color: white;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: var(--card-shadow); cursor: pointer; position: relative; overflow: hidden;
        }
        .bank-card.blocked { filter: grayscale(1); opacity: 0.7; }
        .card-balance { font-size: 30px; font-weight: 800; letter-spacing: -1px; }
        .card-number { font-family: 'Courier New', monospace; font-size: 18px; letter-spacing: 2px; }

        /* Анимированная галочка (Apple Pay style) */
        .success-animation { margin: 40px auto; width: 80px; height: 80px; }
        .checkmark { width: 80px; height: 80px; border-radius: 50%; display: block; stroke-width: 3; stroke: var(--success); stroke-miterlimit: 10; animation: scale .3s ease-in-out .9s both; }
        .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke-miterlimit: 10; stroke: var(--success); fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }

        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        .history-container { background: var(--white); border-radius: 35px 35px 0 0; padding: 25px; margin: 20px -25px 0 -25px; flex-grow: 1; }
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px solid #F2F2F7; }
        .tx-info b { display: block; font-size: 16px; }
        .tx-info span { font-size: 13px; color: var(--gray); }
        .tx-amount { font-weight: 700; }
        .tx-income { color: var(--success); }

        .close-btn { position: absolute; top: 25px; right: 25px; background: rgba(0,0,0,0.05); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div style="width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
</div>

<div class="app-container">

    <div id="screen-login" class="screen">
        <h1 style="margin-top: 50px;">Вход</h1>
        <input type="email" id="login-email" placeholder="Email">
        <input type="password" id="login-password" placeholder="Пароль">
        <button class="btn" onclick="login()">Войти</button>
        <button class="btn-link" onclick="showScreen('screen-reg')">Создать аккаунт</button>
    </div>

    <div id="screen-reg" class="screen">
        <h1 style="margin-top: 50px;">Регистрация</h1>
        <input type="text" id="reg-name" placeholder="Имя Фамилия">
        <input type="email" id="reg-email" placeholder="Email">
        <input type="password" id="reg-password" placeholder="Пароль">
        <button class="btn" onclick="register()">Открыть счет</button>
        <button class="btn-link" onclick="showScreen('screen-login')">Назад</button>
    </div>

    <div id="screen-main" class="screen">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div id="user-name" style="font-weight: 800; font-size: 22px;">...</div>
            <div onclick="logout()" style="color: var(--gray); cursor: pointer;">Выход</div>
        </div>
        <div class="cards-slider" id="cards-container"></div>
        <button class="btn" onclick="showScreen('screen-transfer')" style="background: #1C1C1E;">Перевести</button>
        <div class="history-container">
            <h3>Все операции</h3>
            <div id="main-tx-list"></div>
        </div>
    </div>

    <div id="screen-card-detail" class="screen">
        <div class="close-btn" onclick="showScreen('screen-main')">✕</div>
        <div id="detail-card-visual" style="margin-top: 30px;"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 25px 0;">
            <button class="btn" id="btn-toggle-block" onclick="toggleBlockCard()"></button>
            <button class="btn" style="background: white; color: black; border: 1px solid #ddd;">Реквизиты</button>
        </div>
        <div class="history-container">
            <h3>История по карте</h3>
            <div id="card-tx-list"></div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div class="close-btn" onclick="showScreen('screen-main')">✕</div>
        <h2>Перевод</h2>
        <div id="t-step-1">
            <input type="text" id="search-input" placeholder="Email получателя">
            <button class="btn" onclick="findRecipient()">Далее</button>
        </div>
        <div id="t-step-2" style="display:none; text-align: center;">
            <h3 id="recipient-display">...</h3>
            <input type="number" id="amount-input" placeholder="Сумма ₽">
            <button class="btn" onclick="requestAuth('transfer')">Отправить</button>
        </div>
        <div id="t-success" style="display:none; text-align: center;">
            <div class="success-animation">
                <svg class="checkmark" viewBox="0 0 52 52">
                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <h2>Успешно</h2>
            <button class="btn" onclick="location.reload()">Готово</button>
        </div>
    </div>
</div>

<script>
    // ТВОИ КЛЮЧИ ТУТ
    const firebaseConfig = {
        apiKey: "AIzaSyBYAFyV2_WHPWSrL7vgOjvOV8xi7E7tIko",
        authDomain: "bingusbank-589aa.firebaseapp.com",
        projectId: "bingusbank-589aa",
        storageBucket: "bingusbank-589aa.firebasestorage.app",
        messagingSenderId: "111589726196",
        appId: "1:111589726196:web:5efec8b45a2f54d5220ba1"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let myData = null, myCards = [], currentCard = null, targetUser = null, currentTask = null;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const doc = await db.collection('users').doc(user.uid).get();
            myData = doc.data();
            const cardsSnap = await db.collection('users').doc(user.uid).collection('cards').get();
            myCards = cardsSnap.docs.map(d => ({id: d.id, ...d.data()}));
            renderMain();
            showScreen('screen-main');
        } else { showScreen('screen-login'); }
        document.getElementById('loading-screen').style.display = 'none';
    });

    async function renderMain() {
        document.getElementById('user-name').innerText = `Привет, ${myData.name.split(' ')[0]}!`;
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        myCards.forEach(card => {
            const cardEl = document.createElement('div');
            cardEl.className = `bank-card ${card.blocked ? 'blocked' : ''}`;
            cardEl.style.background = card.color;
            cardEl.innerHTML = `<div>BINGUS</div><div class="card-balance">${myData.balance.toLocaleString()} ₽</div><div class="card-number">•••• ${card.cardNum.slice(-4)}</div>`;
            cardEl.onclick = () => openCardDetails(card);
            container.appendChild(cardEl);
        });
        const txSnap = await db.collection('users').doc(auth.currentUser.uid).collection('transactions').orderBy('date', 'desc').limit(8).get();
        renderTxList(txSnap, 'main-tx-list');
    }

    async function openCardDetails(card) {
        currentCard = card;
        showScreen('screen-card-detail');
        document.getElementById('detail-card-visual').innerHTML = `
            <div class="bank-card" style="background: ${card.color}; width:100%; ${card.blocked ? 'filter:grayscale(1);' : ''}">
                 <div>BINGUS</div>
                 <div class="card-balance">${myData.balance.toLocaleString()} ₽</div>
                 <div class="card-number">${card.cardNum}</div>
                 <div style="display:flex; justify-content:space-between; font-size:12px;">
                    <span>EXP: ${card.expiry || '01/30'}</span><span>CVV: ${card.cvv || '777'}</span>
                 </div>
            </div>`;
        document.getElementById('btn-toggle-block').innerText = card.blocked ? "Разблокировать" : "Заблокировать";
        const txSnap = await db.collection('users').doc(auth.currentUser.uid).collection('transactions').where('cardId', '==', card.id).get();
        renderTxList(txSnap, 'card-tx-list');
    }

    function renderTxList(snap, containerId) {
        const list = document.getElementById(containerId);
        list.innerHTML = snap.empty ? '<p style="text-align:center;">Пусто</p>' : '';
        snap.forEach(doc => {
            const tx = doc.data();
            list.innerHTML += `<div class="tx-item"><div class="tx-info"><b>${tx.title}</b><span>${new Date(tx.date).toLocaleDateString()}</span></div><div class="tx-amount ${tx.type==='income'?'tx-income':''}">${tx.type==='income'?'+':'-'}${tx.amount} ₽</div></div>`;
        });
    }

    async function findRecipient() {
        const email = document.getElementById('search-input').value;
        const snap = await db.collection('users').where('email', '==', email).get();
        if(snap.empty) return alert("Не найден");
        targetUser = { uid: snap.docs[0].id, ...snap.docs[0].data() };
        const tCards = await db.collection('users').doc(targetUser.uid).collection('cards').where('blocked','==',false).get();
        if(tCards.empty) return alert("У получателя нет активных карт");
        targetUser.targetCardId = tCards.docs[0].id;
        document.getElementById('recipient-display').innerText = targetUser.name;
        document.getElementById('t-step-1').style.display = 'none';
        document.getElementById('t-step-2').style.display = 'block';
    }

    async function transferMoney() {
        const amount = parseInt(document.getElementById('amount-input').value);
        if(!amount || amount <= 0 || amount > myData.balance) return alert("Ошибка суммы");
        const myCard = myCards.find(c => !c.blocked);
        if(!myCard) return alert("Нет активных карт");
        const batch = db.batch();
        batch.update(db.collection('users').doc(myData.uid), { balance: firebase.firestore.FieldValue.increment(-amount) });
        batch.update(db.collection('users').doc(targetUser.uid), { balance: firebase.firestore.FieldValue.increment(amount) });
        batch.set(db.collection('users').doc(myData.uid).collection('transactions').doc(), { title: `Перевод ${targetUser.name}`, amount, type: 'outcome', date: Date.now(), cardId: myCard.id });
        batch.set(db.collection('users').doc(targetUser.uid).collection('transactions').doc(), { title: `От ${myData.name}`, amount, type: 'income', date: Date.now(), cardId: targetUser.targetCardId });
        await batch.commit();
        document.getElementById('t-step-2').style.display = 'none';
        document.getElementById('t-success').style.display = 'block';
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function requestAuth(task) { currentTask = task; document.body.insertAdjacentHTML('beforeend', `<div id="temp-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center;"><div style="background:white; padding:30px; border-radius:30px; text-align:center;"><h3>Пароль</h3><input type="password" id="temp-pass" style="border:1px solid #ddd;"><br><button class="btn" onclick="confirmTask()">ОК</button></div></div>`); }
    async function confirmTask() {
        const pass = document.getElementById('temp-pass').value;
        try {
            await auth.currentUser.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, pass));
            document.getElementById('temp-modal').remove();
            if(currentTask === 'transfer') transferMoney();
        } catch(e) { alert("Ошибка"); }
    }

    async function toggleBlockCard() {
        await db.collection('users').doc(auth.currentUser.uid).collection('cards').doc(currentCard.id).update({ blocked: !currentCard.blocked });
        location.reload();
    }

    async function register() {
        const name = document.getElementById('reg-name').value, email = document.getElementById('reg-email').value, pass = document.getElementById('reg-password').value;
        const res = await auth.createUserWithEmailAndPassword(email, pass);
        await db.collection('users').doc(res.user.uid).set({ uid: res.user.uid, name, email, balance: 5000 });
        await db.collection('users').doc(res.user.uid).collection('cards').add({ cardNum: "4444"+Math.random().toString().slice(2,14), color: "linear-gradient(135deg, #FF6B00, #FF9000)", expiry: "01/30", cvv: "123", blocked: false });
        location.reload();
    }

    async function login() {
        try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); } catch(e) { alert("Ошибка"); }
    }
    function logout() { auth.signOut(); }
</script>
</body>
</html>
